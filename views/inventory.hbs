<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link rel="stylesheet" href="/style.css">
    <title>Document</title>
</head>
<body>
    <div id="spinner" style="display:none;">
        <div class="spinner-border" role="status">
            <span class="sr-only"></span>
        </div>
    </div>

    <nav>
        <h4 style="font-size:13px">Logo Placeholder</h4>
        <ul>
            <li><a href="/dashboard">Home</a></li>
            <li><a href="/inventory">Inventory</a></li>
            <li><a href="/dashboard">Pricing</a></li>
            <li><a href="/dashboard">Orders</a></li>
            <li><a href="/dashboard">Messages</a></li>
            <li><a href="/dashboard">Feedback</a></li>
            <li><a href="/dashboard">Payments</a></li>
            <li><a href="/dashboard">Reports</a></li>
        </ul>
    </nav>
    <h4>{{username}} Inventory</h4>
    <div class="inventorySearch">
        <form action="/inventory" method="get">
            <div>
                <label for="searchTerm">Search by Name:</label>
                <input type="text" id="searchTerm" name="searchTerm" class="filter-input" placeholder="Player Name" value="{{searchTerm}}">
            </div>
            <div>
                <label for="sport">Sport:</label>
                <select id="sport" name="sport" class="filter-input" onchange="loadSetsAndYears()">
                    <option value="">All Sports</option>
                    {{#each sports}}
                    <option value="{{this}}">{{this}}</option>
                    {{/each}}
                </select>
            </div>
            <div>
                <label for="cardSet">Card Set:</label>
                <select id="cardSet" name="cardSet" class="filter-input">
                    <option value="">All Sets</option>
                    {{#each cardSets}}
                    <option value="{{this}}" {{#if (eq this ../cardSet)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>
            <div>
                <label for="cardYear">Card Year:</label>
                <select id="cardYear" name="cardYear" class="filter-input">
                    <option value="">All Years</option>
                    {{#each cardYears}}
                    <option value="{{this}}" {{#if (eq this ../cardYear)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>
            <div>
                <button type="submit">Search</button>
            </div>
        </form>
    </div>

<div class="table-container">
    <table>
        <!-- Table Title and Results as Caption -->
        <caption>
            <div class="table-header">
                <h2>Product Catalog</h2>
                <span>{{totalItems}} Results</span>
            </div>
        </caption>

        <thead>
            <tr>
                <th>Sport</th>
                <th>CardImage</th>
                <th>CardName</th>
                <th>CardSet</th>
                <th>CardYear</th>
                <th>CardNumber</th>
                <th>CardColor</th>
                <th>CardVariant</th>
            </tr>
        </thead>
        <tbody>
            {{#each cards}}
            <tr>
                <td>{{this.Sport}}</td>
                <td><img src="{{this.CardImage}}" alt="Card Image"></td>
                <td>{{this.CardName}}</td>
                <td>{{this.CardSet}}</td>
                <td>{{this.CardYear}}</td>
                <td>{{this.CardNumber}}</td>
                <td>{{this.CardColor}}</td>
                <td>{{this.CardVariant}}</td>
            </tr>            
            {{else}}
            <tr><td colspan="8">No cards found</td></tr>
            {{/each}}
        </tbody>
    </table>

    <nav aria-label="Page navigation" class="pagination-bottom">
        <ul class="pagination">
            {{#if showPrevious}}
            <li class="page-item"><a class="page-link" href="?page={{minus currentPage 1}}">Previous</a></li>
            {{/if}}
            {{#if showNext}}
            <li class="page-item"><a class="page-link" href="?page={{plus currentPage 1}}">Next</a></li>
            {{/if}}

        </ul>
    </nav>
</div>

<script>
    function loadSetsAndYears(caller) {
        // Disable the dropdowns while loading
        document.getElementById('sport').disabled = true;
        document.getElementById('cardSet').disabled = true;
        document.getElementById('cardYear').disabled = true;
        document.getElementById('spinner').style.display = 'flex';
        const sport = document.getElementById('sport').value;
        const cardSet = document.getElementById('cardSet').value;
        const year = document.getElementById('cardYear').value;

        if (caller === 'sport') {
            // Fetch card sets based on the sport
            fetch(`/cardsets?sport=${encodeURIComponent(sport)}`)
                .then(response => response.json())
                .then(data => {
                    const setSelect = document.getElementById('cardSet');
                    setSelect.innerHTML = '<option value="">All Sets</option>';
                    data.forEach(set => {
                        const option = document.createElement('option');
                        option.value = set;
                        option.textContent = set;
                        if(set === cardSet) {
                            option.selected = true;
                        }
                        setSelect.appendChild(option);
                    });
                })

                .catch(error => console.error('Error loading sets:', error));
        }

        // Fetch years based on the sport and set
        fetch(`/years?sport=${encodeURIComponent(sport)}&cardSet=${encodeURIComponent(cardSet)}`)
            .then(response => response.json())
            .then(years => {
                const yearSelect = document.getElementById('cardYear');
                yearSelect.innerHTML = '<option value="">All Years</option>';
                years.forEach(yr => {
                    const option = document.createElement('option');
                    option.value = yr;
                    option.textContent = yr;
                    if (yr === year) {  // Check if this is the previously selected year
                        option.selected = true;  // Mark this option as selected
                    }
                    yearSelect.appendChild(option);
                });
                document.getElementById('spinner').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading years:', error);
            })
            .finally(() => {
                // Re-enable dropdowns and hide spinner after fetching is complete
                document.getElementById('sport').disabled = false;
                document.getElementById('cardSet').disabled = false;
                document.getElementById('cardYear').disabled = false;
                document.getElementById('spinner').style.display = 'none';
            });
    }

// Modify event listeners to include the caller (sport or set)
document.getElementById('sport').addEventListener('change', () => loadSetsAndYears('sport'));
document.getElementById('cardSet').addEventListener('change', () => loadSetsAndYears('set'));
document.getElementById('cardYear').addEventListener('change', () => loadSetsAndYears('year'));

</script>

</body>